```{r setup, include=FALSE, echo = FALSE, message=FALSE,warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(inspectdf)
library(dplyr)
library(corrr)
library(ggplot2)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
require(gridExtra)
library(MASS)
library(scales)
library(stargazer)
library(miscTools)

```

```{r, results='asis'}
nft_df = read.csv('/Users/scottlai/Desktop/class/fall2022/702/project/data/archive (4)/witches.csv')
# change the num_sale into categories variables
nft_df$num_sales = with(nft_df, ifelse(nft_df$num_sales > 0, 1, 0))
# delete the un-use columns
nft_df = subset(nft_df, select = -c(description, external_link,permalink,token_metadata, last_sale.transaction.timestamp) )
# variable combine. 

## soft Skills 
nft_df$soft_sklls = rowSums(nft_df[, c('Wonder', 'Wisdom',	'Will',	'Wit', 'Wiles', 'Woe')])
nft_df = subset(nft_df, select = -c(Wonder, Wisdom,	Will,	Wit, Wiles, Woe))

## "props"
nft_df$Necklace = with(nft_df, ifelse(nft_df$Necklace == "", 0, 1))
nft_df$Hat = with(nft_df, ifelse(nft_df$Hat == "", 0, 1))
nft_df$Hair..Back. = with(nft_df, ifelse(nft_df$Hair..Back. == "", 0, 1))
nft_df$Face.Markings = with(nft_df, ifelse(nft_df$Face.Markings == "", 0, 1))
nft_df$Facewear = with(nft_df, ifelse(nft_df$Facewear == "", 0, 1))
nft_df$Hair.Topper = with(nft_df, ifelse(nft_df$Hair.Topper == "", 0, 1))
nft_df$Back.Item = with(nft_df, ifelse(nft_df$Back.Item == "", 0, 1))
nft_df$Earrings = with(nft_df, ifelse(nft_df$Earrings == "", 0, 1))
nft_df$Forehead.Jewelry = with(nft_df, ifelse(nft_df$Forehead.Jewelry == "", 0, 1))
nft_df$Hair..Middle. = with(nft_df, ifelse(nft_df$Hair..Middle. == "", 0, 1))
nft_df$Mask = with(nft_df, ifelse(nft_df$Mask == "", 0, 1))
nft_df$Outerwear = with(nft_df, ifelse(nft_df$Outerwear == "", 0, 1))


nft_df$props = rowSums(nft_df[, c('Necklace', 'Hat',	'Hair..Back.',	'Face.Markings', 'Hair.Topper', 'Back.Item','Earrings','Forehead.Jewelry','Hair..Middle.','Mask','Outerwear','Facewear')])
nft_df = subset(nft_df, select = -c(Necklace, Hat,	Hair..Back.,	Face.Markings, Hair.Topper, Back.Item,Earrings,Forehead.Jewelry,Hair..Middle.,Mask,Outerwear,Facewear))



nft_df$Skin.Tone <- factor(nft_df$Skin.Tone)
nft_df$Rising.Sign <- factor(nft_df$Rising.Sign)
nft_df$Eyebrows <- factor(nft_df$Eyebrows)
nft_df$Body.Shape <- factor(nft_df$Body.Shape)
nft_df$Moon.Sign <- factor(nft_df$Moon.Sign)
nft_df$Hair.Color <- factor(nft_df$Hair.Color)
nft_df$Sun.Sign <- factor(nft_df$Sun.Sign)
nft_df$Eye.Style <- factor(nft_df$Eye.Style)
nft_df$Eye.Color <- factor(nft_df$Eye.Color)
nft_df$Mouth <- factor(nft_df$Mouth)
nft_df$Archetype.of.Power <- factor(nft_df$Archetype.of.Power)
nft_df$Hair..Front. <- factor(nft_df$Hair..Front.)
nft_df$Top <- factor(nft_df$Top)
nft_df$Background <- factor(nft_df$Background)

nft_df$sale_status <- factor(nft_df$num_sales)

#str(nft_df)
```


```{r, message=FALSE,warning=FALSE}
list_data = list(names(nft_df))
mt1 <- matrix(unlist(list_data), nrow = 4, byrow = TRUE)
a = data.frame(mt1)
#colnames(a) = c('variables')
#as.data.frame(t(a)) %>% kable(col.names = NULL) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", #"responsive")) %>% kable_paper(full_width = T) %>% column_spec(1:1, bold = T)
```  


# Results  

### EDA  

#### Plots for Soft Sklls count, Props Count, Total Price (Unit: Gwei) Count, Sold or Non-Sold  

```{r,fig.height=7.5,fig.width=12,warning=FALSE,message=FALSE,fig.align='center'}
plot3 = ggplot(nft_df, aes(x = soft_sklls)) +
  geom_bar() +
  ggtitle("Barplot for Soft Sklls Count") +
  xlab('soft skills') +
  geom_text(stat='count', aes(label=..count..), vjust=-0.5,size = 3) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(hjust = 0.5))
plot4 = ggplot(nft_df, aes(x = props)) +
  geom_bar() +
  ggtitle("Barplot for Props Count") +
  geom_text(stat='count', aes(label=..count..), vjust=-0.5,size = 3) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(hjust = 0.5))

plot1 = ggplot(nft_df, aes(x = last_sale.total_price)) +
  geom_freqpoly() +
  ggtitle("Freqpoly Plot for Total Price (Unit: Gwei) Count") +
  xlab('total price') +
  geom_text(stat='count', aes(label=..count..), vjust=-0.5,size = 3) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(hjust = 0.5))

plot2 = ggplot(nft_df, aes(x = sale_status)) +
  geom_bar() +
  ggtitle("Barplot for Sold(1) or Not(0)") +
  xlab('sale status') +
  geom_text(stat='count', aes(label=..count..), vjust=-0.5,size = 3) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(hjust = 0.5))
grid.arrange(plot1, plot2, plot3, plot4, ncol=2, nrow = 2)

```

From the Frequence plot we can see the total price count distribution across the range, we can find out most Crypto Coven NFTs are low price, only a few NFTs been sold over $5e^{18}$ Gwei (5 ETH or $6275). The sale status count bar plot indicates that we have almost the same proportion of NFT's sold as NFT's not sold. This allows for simple interpretations of our logistic regression model results since our outcome variable is balanced. We also see that soft skills and props are roughly normally distributed and so Crypto Coven NFT's with very high or very low values are rare and is useful information for our analysis.


#### Bar plots for Body shape count, eyebrows count, background count, and Skin.Ton. count.  

```{r,fig.height=8.5,fig.width=12,warning=FALSE,fig.align='center'}
plot1 = ggplot(nft_df, aes(x = 	Skin.Tone)) +
  geom_bar() +
  ggtitle("Barplot for Skin.Tone Count") +
  geom_text(stat='count', aes(label=..count..), vjust=-0.5,size = 3) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(hjust = 0.5))
plot2 = ggplot(nft_df, aes(x = 	Body.Shape)) +
  geom_bar() +
  ggtitle("Barplot for Body Shape Count") +
  geom_text(stat='count', aes(label=..count..), vjust=-0.5,size = 3) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(hjust = 0.5))

plot3 = ggplot(nft_df, aes(x = Eyebrows)) +
  geom_bar() +
  ggtitle("Freqpoly Plot for Eyebrows Count") +
  geom_text(stat='count', aes(label=..count..), vjust=-0.5,size = 3) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(hjust = 0.5))

plot4 = ggplot(nft_df, aes(x = Background)) +
  geom_bar() +
  ggtitle("Barplot for Background count") +
  geom_text(stat='count', aes(label=..count..), vjust=-0.5,size = 3) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        plot.title = element_text(hjust = 0.5))
grid.arrange(plot1, plot2, plot3, plot4, ncol=2, nrow = 2)

```  



```{r}
nft_df_3 = subset(nft_df, select = -c(id,name,token_id,owner.user.username,owner.address,sale_status,last_sale.payment_token.usd_price))
nft_df_3 <- nft_df_3[complete.cases(nft_df_3),]

mod_price <- glm(formula = last_sale.total_price ~ Skin.Tone + Eyebrows + Background, data = nft_df_3)
s1 <- summary(mod_price)

```  


#### Comparison of the price and counts of subcategories of Skin.Tone, Eyebrows, Background  

```{r}
eda_skin <- nft_df_3[,c("Skin.Tone","last_sale.total_price")]
eda_skin <- group_by(eda_skin, Skin.Tone)
a <- eda_skin %>% summarise(
  last_sale.total_price = mean(last_sale.total_price)
)
eda_eyebrows <- nft_df_3[,c("Eyebrows","last_sale.total_price")]
eda_eyebrows <- group_by(eda_eyebrows, Eyebrows)
b <- eda_eyebrows %>% summarise(
  last_sale.total_price = mean(last_sale.total_price)
)
eda_background <- nft_df_3[,c("Background","last_sale.total_price")]
eda_background <- group_by(eda_background, Background)
c <- eda_background %>% summarise(
  last_sale.total_price = mean(last_sale.total_price)
)
```

```{r,fig.height=6, fig.width=8,fig.align='center'}
l9 <- ggplot(a, aes(Skin.Tone))
l9 <- l9 + geom_bar( aes(x=Skin.Tone, y=last_sale.total_price), stat="identity") 
l8 <- ggplot(nft_df_3, aes(Skin.Tone,y="count"))
l8 <- l8 + geom_bar(stat = "identity")+ylab("count")

l5 <- ggplot(b, aes(Eyebrows))
l5 <- l5 + geom_bar( aes(x=Eyebrows, y=last_sale.total_price), stat="identity")+coord_flip()
l4 <- ggplot(nft_df_3, aes(Eyebrows,y="count"))
l4 <- l4 + geom_bar(stat = "identity")+coord_flip()+ylab("count")

l6 <- ggplot(c, aes(Background))
l6 <- l6 + geom_bar( aes(x=Background, y=last_sale.total_price), stat="identity")+coord_flip()
l3 <- ggplot(nft_df_3, aes(Background,y="count"))
l3 <- l3 + geom_bar(stat = "identity")+coord_flip()+ylab("count")
 # +coord_flip()
grid.arrange(l8,l9,l4,l5,l3,l6,ncol=2, nrow = 3,top="Linear Regression Result: Tone & Background & Eyebrows")
```  


### Final Linear Regression Model  


#### Linear Regression Model Assessment 

```{r,message=FALSE}
# s1$call
cii <- confint(mod_price)
c2 <- cbind(cii,s1$coefficients)
c2[,1] <- as.numeric(scientific(c2[,1]))
c2[,2] <- as.numeric(scientific(c2[,2]))
c2[,3] <- as.numeric(scientific(c2[,3]))
c2[,4] <- as.numeric(scientific(c2[,4]))
c2[,5] <- as.numeric(scientific(c2[,5]))
c2[,6] <- as.numeric(scientific(c2[,6]))

c3 <- c2[c(1,5,8,9,10,12,15,16,17,24,25),]
# knitr::kable(s1$coefficients,"simple",digits = 3)

# knitr::kable(s1$coefficients, format = "simple", escape = FALSE,digits = c(3,3,3,7),caption = 'Summary Table of coeffficients for the Regression Model')
# knitr::kable(ci,"simple",digits = 3)
knitr::kable(c3,"simple",digits = 3,caption = 'Linear Regression for Price (include only significant subcategories)')
# knitr::kable(c2,"simple",digits = 3,caption = 'Linear Regression for Price')
```

### Final Logistic Regression Model 

#### Logistic Regression Model Assessment

```{r, echo=FALSE, results="asis", header=FALSE, message=FALSE, warning=FALSE,}
nft_df_2 = subset(nft_df, select = -c(id,name,token_id,owner.user.username,owner.address,last_sale.total_price,
                                      last_sale.payment_token.usd_price))

mod <- glm(sale_status ~ Skin.Tone + Body.Shape, data = nft_df_2, family = binomial)
#summary(mod)
ci <- exp(confint(mod))
```

```{r, fig.align='center',echo=FALSE, message=FALSE, warning=FALSE}
p_vals <- c("0.710","0.053*","0.782","<0.001***","0.722","0.964","0.293","0.128","0.075*")
mat <- matrix(c(round(summary(mod)$coefficients[,1:3],4),p_vals),nrow=9,ncol=4)
mat <- insertRow(mat,2,c("-","-","-","-"))
mat <- insertRow(mat,9,c("-","-","-","-"))

rownames(mat) <- c("Intercept", "Skin Tone: Dawn", "Skin Tone: Day", "Skin Tone: Dusk", "Skin Tone: Midnight", "Skin Tone: Night", "Skin Tone: Sunset", "Skin Tone: Twilight", "Body Shape: Chiseled", "Body Shape: Lithe", "Body Shape: Soft")
#kable(mat, row.names = TRUE, col.names = c("Estimate","SE","t","p-value"), format="latex", booktabs=T, caption="Logistic Regression for Sale Odds") %>%
#kable_styling(position="center",latex_options = c("hold_position"))

knitr::kable(mat,"simple",digits = 3,caption = 'Logistic Regression for Sale Odds',col.names = c("Estimate","SE","t","p-value"))
```

```{r,fig.height=3, fig.width=8,fig.align='center'}

ns_st <- prop.table(table(nft_df_2$sale_status, nft_df_2$Skin.Tone),2)

ns_bs <- prop.table(table(nft_df_2$sale_status, nft_df_2$Body.Shape),2)

par(mfrow=c(1,2))
barplot(ns_st, legend.text = TRUE, las=2, cex.names=.5)
barplot(ns_bs, legend.text = TRUE, las=2, cex.names=.8)

```


- the data only contains selling information before 2020 which is out of date. We are trying to apply the OpenSea API in the future to get updates data and informations.


```{r, results='asis', echo=FALSE}
cat("\\newpage")
```

# Appendix

```{r,fig.height=3.8}
library(performance)
library(see)
result <- binned_residuals(mod)
plot(result)

```  
```{r,warning=FALSE,fig.height=5.3}
# Residuals plots for linear regression model 
par(mfrow = c(2,2))
plot(mod_price)
```


```{r ci output, echo=FALSE, results="asis", header=FALSE, message=FALSE, warning=FALSE,}
stargazer(ci, type = "latex", no.space = TRUE,
         report = ('vcsp*'), single.row = TRUE, header = FALSE,
         column.sep.width = "0.2pt",
         font.size = "small",
         title="Exponentiated Estimate Confidence Interval")
knitr::kable(c2,"simple",digits = 3,caption = 'Linear Regression for Price (Full table)')
```
